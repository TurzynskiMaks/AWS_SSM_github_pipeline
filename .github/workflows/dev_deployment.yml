name: Build all Dockerfiles & SSH deploy

on:
  push:
    branches: [ "main" ]

permissions:
  contents: read


env:
  DOCKERHUB_ORG: ${{ secrets.DOCKERHUB_USERNAME }}

jobs:
  build_and_push_all:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout source
        uses: actions/checkout@v4

      - name: Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Find, build and push every Dockerfile with tag :latest
        shell: bash
        run: |
          set -euo pipefail

          mapfile -t DOCKER_DIRS < <(find . -type f -name Dockerfile -printf '%h\n' | sort -u)

          if [ ${DOCKER_DIRS[@]} eq - ]; then
            echo "No Dockerfiles in repo." >&2
            exit 1
          fi

          echo "Found Dockerfiles:"
          printf ' - %s\n' "${DOCKER_DIRS[@]}"

          for dir in "${DOCKER_DIRS[@]}"; do
            name="$(basename "$dir")"

            image="${DOCKERHUB_ORG}/${name}:latest"

            echo "::group::Build $ push ${image}"
            echo "Building from: ${dir}"
            docker build -t "${image}" "${dir}"
            docker push "${image}"
            echo "::endgroup::"
          done
  deploy_via_ssh:
    needs: build_and_push_all
    runs-on: ubuntu-latest
    steps:
      - name: Checkout source for docker-compose.yml
        uses: actions/checkout@v4

      - name: Add SSH key
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.EC2_SSH_KEY }}

      - name: Add EC2 host key to known_hosts
        run: |
          mkdir -p ~/.ssh
          ssh-keyscan -H ${{ secrets.EC2_HOST }} >> ~/.ssh/known_hosts


      - name: Copy docker-compose.yml
        run: |
          scp docker-compose.yml ${{ secrets.EC2_USER }}@${{ secrets.EC2_HOST }}:/home/ec2-user/webapp

      - name: Deploy on EC2
        env:
          DOCKERHUB_USERNAME: ${{ secrets.DOCKERHUB_USERNAME }}
        run: |
          ssh ${{ secrets.EC2_USER }}@${{ secrets.EC2_HOST }} bash -se << 'E0F'
          set -euo pipefail

          cd webapp

          docker-compose pull || true

          docker-compose up -d --build

          docker image prune -f || true
          E0F
      
